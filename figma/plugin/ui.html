<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <style>
            body {
                font-family: sans-serif;
                margin: 0;
                padding: 8px;
                background: #1e1e1e;
                color: white;
            }
            #main {
                display: flex;
                align-items: center;
                gap: 8px;
            }
            #status {
                font-size: 11px;
                flex: 1;
            }
            button {
                padding: 4px 8px;
                font-size: 11px;
                cursor: pointer;
                background: #333;
                color: white;
                border: 1px solid #555;
                border-radius: 4px;
            }
            #setup {
                display: none;
                margin-top: 8px;
            }
            input {
                width: 100%;
                padding: 4px;
                box-sizing: border-box;
                font-size: 11px;
            }
        </style>
    </head>
    <body>
        <div id="main">
            <div id="status">‚ö™ –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</div>
            <button id="settingsBtn">‚öô</button>
            <button id="closeBtn">‚úï</button>
        </div>
        <div id="setup">
            <input id="userId" placeholder="Figma User ID" />
            <button id="connectBtn" style="width: 100%; margin-top: 4px">
                –ü–æ–¥–∫–ª—é—á–∏—Ç—å
            </button>
        </div>

        <script>
            let ws = null;
            let currentUserId = null;
            let reconnectTimer = null;

            parent.postMessage({ pluginMessage: { type: "ready" } }, "*");

            window.onmessage = (event) => {
                const msg = event.data.pluginMessage;
                if (!msg) return;

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è —Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–º userId
                if (msg.type === "saved-id" && msg.userId) {
                    document.getElementById("userId").value = msg.userId;
                    connect(msg.userId);
                }

                // –û—Ç–≤–µ—Ç—ã –æ—Ç code.js ‚Üí –ø–µ—Ä–µ—Å—ã–ª–∞–µ–º –≤ backend
                if (msg.type === "response") {
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify(msg));
                    }
                }
            };

            document.getElementById("settingsBtn").onclick = () => {
                const s = document.getElementById("setup");
                s.style.display = s.style.display === "none" ? "block" : "none";
            };

            document.getElementById("closeBtn").onclick = () => {
                parent.postMessage({ pluginMessage: { type: "close" } }, "*");
            };

            document.getElementById("connectBtn").onclick = () => {
                const userId = document.getElementById("userId").value.trim();
                if (!userId) return;
                clearTimeout(reconnectTimer);
                connect(userId);
                document.getElementById("setup").style.display = "none";
            };

            function connect(userId) {
                currentUserId = userId;
                if (ws) ws.close();

                ws = new WebSocket(
                    "wss://gustless-osmometrically-celinda.ngrok-free.dev/ws"
                );
                ws.onopen = () => {
                    ws.send(JSON.stringify({ type: "register", userId }));
                    parent.postMessage(
                        { pluginMessage: { type: "save-id", userId } },
                        "*"
                    );
                    document.getElementById("status").textContent =
                        "üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ";
                };
                ws.onmessage = (event) => {
                    const cmd = JSON.parse(event.data);
                    parent.postMessage({ pluginMessage: cmd }, "*");
                };
                ws.onerror = () => {
                    document.getElementById("status").textContent = "üî¥ –û—à–∏–±–∫–∞";
                };
                ws.onclose = () => {
                    document.getElementById("status").textContent =
                        "üü° –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...";
                    if (currentUserId) {
                        reconnectTimer = setTimeout(() => connect(currentUserId), 3000);
                    }
                };
            }
        </script>
    </body>
</html>
